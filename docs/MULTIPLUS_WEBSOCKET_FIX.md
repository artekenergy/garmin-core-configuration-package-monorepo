# MultiPlus WebSocket Fix - Signal Binding Resolution

**Date:** October 16, 2025  
**Status:** ✅ Fixed

## Problem

The MultiPlus control component was displaying correctly but **not sending WebSocket messages** when the mode buttons (Off/On/Charger Only) were clicked.

## Root Cause

The MultiPlus button entries in `hardware-config-core.json` were missing the `signals` property required by the binding resolver.

### How Signal Resolution Works

1. **TabGenerator** (`tabGenerator.ts`) creates bindings with channel names:

   ```typescript
   modeOff: {
     type: 'empirbus',
     channel: 'press-multiplus-off',  // ← String reference
     property: 'state',
   }
   ```

2. **Binding Resolver** (`binding-resolver.ts`) looks up the numeric signal ID:

   ```typescript
   const output = schema.hardware.outputs.find((out) => out.id === 'press-multiplus-off');

   // Looks for: output.signals.momentary
   if (sigs && action && sigs[action] != null) {
     return Number(sigs[action]); // ← Returns numeric ID
   }
   ```

3. **Problem:** The hardware config entries looked like this:

   ```json
   {
     "id": "press-multiplus-off",
     "source": "power",
     "channel": 132,
     "control": "push-button",
     "label": "MultiPlus Off"
     // ❌ Missing "signals" property!
   }
   ```

4. **Result:** The resolver couldn't find `signals.momentary`, so it returned `null`, preventing WebSocket messages from being sent.

## Solution

Added the missing `signals` property with `momentary` key to all three MultiPlus button entries:

```json
{
  "id": "press-multiplus-off",
  "source": "power",
  "channel": 132,
  "control": "push-button",
  "label": "MultiPlus Off",
  "signals": {
    "momentary": 132  // ✅ Added this
  }
},
{
  "id": "press-multi-on",
  "source": "power",
  "channel": 133,
  "control": "push-button",
  "label": "MultiPlus On",
  "signals": {
    "momentary": 133  // ✅ Added this
  }
},
{
  "id": "press-multiplus-charger-only",
  "source": "power",
  "channel": 134,
  "control": "push-button",
  "label": "MultiPlus Charger Only",
  "signals": {
    "momentary": 134  // ✅ Added this
  }
}
```

## Files Modified

- `configuration/hardware-config-core.json` - Added `signals.momentary` to three MultiPlus buttons
- `packages/hmi-ui/public/hardware-config.json` - Updated via prebuild
- `packages/hmi-ui/src/components/registry.ts` - Registered MultiplusControl component

## Deployment

Ran the full deployment pipeline:

```bash
pnpm run prebuild
pnpm run deploy:full:win:skipfly
```

**Build Output:**

- ✅ HMI UI built successfully (221.28 kB)
- ✅ Deployment package created: `garmin-hmi-deployment-20251016_174650.zip` (0.75 MB)
- ✅ All schemas validated (no static value bindings)

## How to Verify

1. **Open** `garmin-bundle/web/index1.html` in browser
2. **Navigate** to the Power tab
3. **Find** the "AC Power" section (auto-generated by tabGenerator)
4. **Click** any mode button (Off, On, or Charger Only)
5. **Check browser console** - Should see:
   ```
   [MultiplusControl] Mode: off Press (1) ChannelID: 132
   [MultiplusControl] Mode: off Release (0) ChannelID: 132
   ```
6. **Check WebSocket traffic** - Should send messages:
   ```json
   {
     "messagetype": 17,
     "messagecmd": 1,
     "size": 3,
     "data": [132, 0, 1]  // Press
   }
   {
     "messagetype": 17,
     "messagecmd": 1,
     "size": 3,
     "data": [132, 0, 0]  // Release after 100ms
   }
   ```

## Related Issues Fixed

### Issue 1: Component Not Registered

The `MultiplusControl` component existed but wasn't registered in `registry.ts`, causing it to be skipped during rendering.

**Fix:** Added to registry:

```typescript
import { MultiplusControl } from './MultiplusControl';

export const COMPONENT_REGISTRY: Record<string, FunctionComponent<any>> = {
  // ... other components
  'multiplus-control': MultiplusControl,
};
```

### Issue 2: Missing CSS File

The component imported `./MultiplusControl.css` which already existed, so no issue here.

## Technical Details

### Signal ID Mapping

| Button ID                      | Channel | Signal Type | Signal ID |
| ------------------------------ | ------- | ----------- | --------- |
| `press-multiplus-off`          | 132     | momentary   | 132       |
| `press-multi-on`               | 133     | momentary   | 133       |
| `press-multiplus-charger-only` | 134     | momentary   | 134       |

### WebSocket Message Format

**Message Type:** 17 (EmpirBus Toggle/Momentary)  
**Message Command:** 1 (Set State)  
**Data Structure:**

```
[channel_lo, channel_hi, value]
```

- `channel_lo`: Lower 8 bits of channel ID
- `channel_hi`: Upper 8 bits of channel ID
- `value`: 1 for press, 0 for release

### Button Click Flow

1. User clicks "OFF" button
2. `handleModeClick('off')` is called
3. Resolves `modeOff` binding to channel ID 132
4. Encodes: `{ lo: 132, hi: 0 }`
5. Sends press message: `[132, 0, 1]`
6. Waits 100ms
7. Sends release message: `[132, 0, 0]`

## Best Practices Learned

### ✅ Always Include Signals Property

For ANY output that will be used in component bindings:

```json
{
  "id": "your-button-id",
  "control": "push-button",
  "channel": 123,
  "signals": {
    "momentary": 123 // Required for button clicks
  }
}
```

For dimmer controls:

```json
{
  "id": "your-dimmer-id",
  "control": "dimmer",
  "channel": 456,
  "signals": {
    "toggle": 456,
    "momentary": 457,
    "dimmer": 458
  }
}
```

For read-only values:

```json
{
  "id": "your-sensor-id",
  "control": "signal-value",
  "channel": 789,
  "signals": {
    "value": 789 // Required for gauges/indicators
  }
}
```

### ✅ Register New Components

When creating a new component type, add it to `packages/hmi-ui/src/components/registry.ts`:

```typescript
import { YourNewComponent } from './YourNewComponent';

export const COMPONENT_REGISTRY: Record<string, FunctionComponent<any>> = {
  // ...
  'your-component-type': YourNewComponent,
};
```

### ✅ Test Signal Resolution

When debugging binding issues, check:

1. Does the hardware config entry exist with the expected ID?
2. Does it have a `signals` property?
3. Does the signal key match the action type (`momentary`, `toggle`, `dimmer`, `value`)?
4. Check browser console for resolver warnings

## Conclusion

The MultiPlus controls are now fully functional and sending WebSocket messages. The issue was a simple missing `signals` property in the hardware configuration, which prevented the binding resolver from finding the numeric channel IDs.

**Next Time:** When a component renders but doesn't respond to interactions, always check that the hardware config entries have the complete `signals` mapping for the expected action types.
