# Multiplus Test Controls Component

## Overview

The `MultiplusTestControls` component provides quick-access buttons for testing Multiplus inverter/charger modes on the Garmin HMI display. These are simple test buttons that send momentary signals to control the hardware without requiring full component bindings.

## Features

- **Three Mode Buttons**: OFF, ON, CHARGER ONLY
- **Momentary Action**: Sends press (true) followed by release (false) after 100ms
- **Leg Support**: Can be instantiated for L1 and/or L2
- **No Bindings Required**: Uses hardcoded channel names for testing
- **WebSocket Communication**: Uses the HMI UI's WebSocket adapter pattern

## Component Files

- **Component**: `packages/hmi-ui/src/components/MultiplusTestControls.tsx`
- **Styles**: `packages/hmi-ui/src/components/MultiplusTestControls.css`
- **Schema**: `packages/schema/src/components/multiplus-test-controls.ts`

## Schema Definition

```typescript
{
  type: 'multiplus-test-controls',
  id: string,
  label: string,
  leg?: 1 | 2  // Optional, defaults to 1
}
```

## Hardware Channels Used

The component uses these hardcoded channel names:

- **OFF Mode**: `press-multiplus-off`
- **ON Mode**: `press-multi-on`
- **CHARGER ONLY Mode**: `press-multiplus-charger-only`

These channels are resolved to hardware signal IDs via the binding resolver:

- Signal 132: Multiplus OFF
- Signal 133: Multiplus ON
- Signal 134: Multiplus CHARGER ONLY

## Automatic Generation

The component is automatically generated by the tab generator when multiplus is enabled in the schema:

```json
{
  "power": {
    "multiplus": {
      "l1": true,
      "l2": true
    }
  }
}
```

When either `l1` or `l2` is enabled, the tab generator creates:

1. A "Test Controls" section in the Power tab
2. One test controls component per enabled leg

## Visual Design

The buttons are styled with distinct colors:

- **OFF**: Red background (#dc2626)
- **ON**: Green background (#16a34a)
- **CHARGER**: Yellow/gold background (#ca8a04)

Each button has hover and active states for visual feedback.

## Integration with Tab Generator

In `packages/hmi-ui/src/utils/tabGenerator.ts`:

```typescript
function applyPowerConfig(tab: UITabWithDerived, schema: UISchema) {
  const power = schema.power;

  if (!power || !power.multiplus) return;

  // ... generate multiplus-control components ...

  // Add test controls section if any multiplus enabled
  if (power.multiplus.l1 || power.multiplus.l2) {
    const testSection = ensureSection(tab, 'section-test-controls', 'Test Controls');

    if (power.multiplus.l1) {
      testSection.components.push({
        id: 'multiplus-test-controls-l1',
        type: 'multiplus-test-controls',
        label: 'L1 Quick Test',
        leg: 1,
      });
    }

    if (power.multiplus.l2) {
      testSection.components.push({
        id: 'multiplus-test-controls-l2',
        type: 'multiplus-test-controls',
        label: 'L2 Quick Test',
        leg: 2,
      });
    }
  }
}
```

## Usage on Device

1. Navigate to the Power tab on the Garmin HMI display
2. Scroll to the "Test Controls" section (appears after AC Power section)
3. Tap OFF, ON, or CHARGER buttons to control the Multiplus mode
4. Each button press sends a momentary signal (100ms duration)

## Difference from MultiplusControl

| Feature         | MultiplusControl                                       | MultiplusTestControls   |
| --------------- | ------------------------------------------------------ | ----------------------- |
| **Purpose**     | Full monitoring + control                              | Quick test buttons only |
| **Displays**    | AC input voltage, AC output voltage, AC output current | None                    |
| **Bindings**    | Required (6 bindings per leg)                          | Not required            |
| **Use Case**    | Production UI                                          | Development/testing     |
| **Visual Size** | Large composite component                              | Compact button row      |

## Development Notes

- Component is ES2017 compliant (no optional chaining, uses function() syntax)
- WebSocket adapter accessed via `getWebSocketAdapter()`
- Bindings resolved via `resolveBindingToChannelId()`
- Messages created via `createToggleMessage(channelId, state)`
- Console logging for debugging press/release actions

## Deployment

The test controls component is included in the HMI UI deployment package:

- **Package**: `garmin-hmi-deployment-YYYYMMDD_HHMMSS.zip`
- **Location**: Automatically included when multiplus is enabled in schema
- **Size**: ~780K total package

## Testing

To test the component:

1. Enable multiplus in your schema (via web-configurator or schema.json)
2. Build HMI UI: `pnpm --filter @gcg/hmi-ui build`
3. Deploy to device: `./scripts/deploy-full.sh`
4. Upload ZIP to Garmin display
5. Navigate to Power tab â†’ Test Controls section
6. Press buttons and verify WebSocket messages in console

## Related Components

- **MultiplusControl**: Full-featured composite component with monitoring
- **Button**: Base button component for single actions
- **Toggle**: Switch component for on/off states

## Future Enhancements

Potential improvements:

- Add visual feedback when button is pressed
- Show current mode state (highlight active button)
- Add confirmation dialog for OFF mode
- Support custom signal IDs via schema config
- Add success/error toast notifications
