# Build Artifacts Documentation

This document explains the build artifacts in the monorepo, how they're generated, and why they should not be committed to version control.

## Overview

The monorepo generates several build artifacts during the build process. These are **auto-generated** files that should never be manually edited or committed to git.

---

## üì¶ Build Artifacts

### 1. `packages/hmi-ui/dist/`

**What it is:** Production-optimized build of the HMI UI (Preact application)

**Generated by:**

```bash
pnpm --filter @gcg/hmi-ui build
```

**Build script:** Uses Vite to bundle TypeScript + Preact into optimized JavaScript/CSS

**Contents:**

- `hmi-assets/` - Bundled JS/CSS with content hashes (e.g., `index-Bs6ACjXq.js`)
- `index.html` - Entry point for HMI application
- `icons/` - SVG icon assets
- JSON config files (`dataitems.json`, `schema.json`, etc.)

**Used by:**

- Garmin devices (deployed via `deploy:web` script)
- Web configurator (copied to `deployment-package/`)

**Git status:** ‚úÖ Already ignored via `dist/` in `.gitignore`

---

### 2. `packages/web-configurator/dist/`

**What it is:** Production build of the web-based schema configurator

**Generated by:**

```bash
pnpm --filter @gcg/web-configurator build
```

**Build process:**

1. Runs `copy-hmi-assets.js` to prepare deployment package
2. TypeScript compilation (`tsc`)
3. Vite build for production bundle

**Contents:**

- Bundled React application
- Static assets
- `index.html` entry point

**Used by:** Deployed to fly.io or served locally

**Git status:** ‚úÖ Already ignored via `dist/` in `.gitignore`

---

### 3. `packages/web-configurator/public/deployment-package/`

**What it is:** Complete deployment package ready for export as ZIP

**Generated by:**

```bash
node packages/web-configurator/scripts/copy-hmi-assets.js
```

**Automatically runs before build:**

```bash
pnpm --filter @gcg/web-configurator build
```

**Build script:** `copy-hmi-assets.js` orchestrates the copy process

**Contents:**

```
deployment-package/
‚îú‚îÄ‚îÄ web/                    # HMI UI build + web assets (~4.8MB)
‚îÇ   ‚îú‚îÄ‚îÄ hmi-assets/        # Vite build output
‚îÇ   ‚îú‚îÄ‚îÄ icons/             # SVG icons
‚îÇ   ‚îú‚îÄ‚îÄ images/            # PNG/SVG images
‚îÇ   ‚îú‚îÄ‚îÄ garmin/            # Garmin config JSONs
‚îÇ   ‚îî‚îÄ‚îÄ index.html
‚îú‚îÄ‚îÄ configuration/          # Hardware configs + channel mappings (~500KB)
‚îÇ   ‚îú‚îÄ‚îÄ hardware-config*.json
‚îÇ   ‚îú‚îÄ‚îÄ channel-mapping.json
‚îÇ   ‚îî‚îÄ‚îÄ *.ebp files
‚îú‚îÄ‚îÄ services/              # Systemd service files (~20KB)
‚îÇ   ‚îî‚îÄ‚îÄ *.service files
‚îî‚îÄ‚îÄ manifest.json          # Auto-generated file listing
```

**Size:** ~5.3MB total

**Source directories:**

- `garmin-bundle/web/` ‚Üí `deployment-package/web/`
- `garmin-bundle/configuration/` ‚Üí `deployment-package/configuration/`
- `garmin-bundle/services/` ‚Üí `deployment-package/services/`

**Purpose:** Provides all files needed for the web configurator's ZIP export feature

**Git status:** ‚úÖ Ignored as of bloat cleanup (added to `.gitignore`)

**Why it exists:** The web configurator's Export page creates a ZIP containing this entire directory, allowing users to download a complete deployment package.

---

### 4. `packages/web-configurator/public/hmi-dist/` ‚ö†Ô∏è

**What it is:** Legacy/outdated HMI distribution files

**Status:** ‚ö†Ô∏è **Should be removed or gitignored**

**Generated by:** Unclear - appears to be old build output

**Git status:** ‚ùå Currently tracked in git (should be ignored)

**Action needed:** Add to `.gitignore`:

```bash
echo "packages/web-configurator/public/hmi-dist/" >> .gitignore
git rm -r --cached packages/web-configurator/public/hmi-dist/
```

---

### 5. `garmin-bundle/`

**What it is:** Master deployment bundle (source for `deployment-package/`)

**Generated by:**

```bash
pnpm --filter @gcg/hmi-ui deploy:web
# Runs: ./scripts/deploy-to-web.sh
```

**Purpose:** Contains the canonical web deployment structure that gets copied to `deployment-package/`

**Git status:** ‚úÖ Already ignored in `.gitignore`

---

## üîÑ Build Dependency Chain

```mermaid
graph TD
    A[Source Code] -->|tsc + vite build| B[packages/hmi-ui/dist/]
    B -->|deploy:web script| C[garmin-bundle/]
    C -->|copy-hmi-assets.js| D[deployment-package/]
    D -->|ExportPage ZIP| E[User download]

    F[web-configurator src] -->|tsc + vite build| G[web-configurator/dist/]
    G -->|fly deploy| H[Production]
```

**Flow:**

1. Build HMI UI: `pnpm --filter @gcg/hmi-ui build` ‚Üí creates `dist/`
2. Deploy to bundle: `pnpm --filter @gcg/hmi-ui deploy:web` ‚Üí creates `garmin-bundle/`
3. Build web configurator: `pnpm --filter @gcg/web-configurator build` ‚Üí copies bundle to `deployment-package/` ‚Üí builds `dist/`

---

## üö´ What Should NOT Be Committed

### Already Gitignored ‚úÖ

- `dist/` - All package dist folders
- `garmin-bundle/` - Deployment bundle source
- `packages/web-configurator/public/deployment-package/` - Export package cache

### Should Be Added to .gitignore ‚ö†Ô∏è

- `packages/web-configurator/public/hmi-dist/` - Legacy build output

---

## üõ†Ô∏è How to Regenerate Build Artifacts

### For Development

```bash
# Build everything (from monorepo root)
pnpm build

# Or build specific packages
pnpm --filter @gcg/hmi-ui build
pnpm --filter @gcg/web-configurator build
```

### For Production Deployment

```bash
# 1. Build HMI UI
pnpm --filter @gcg/hmi-ui build

# 2. Deploy to garmin-bundle
pnpm --filter @gcg/hmi-ui deploy:web

# 3. Build web configurator (auto-copies deployment-package)
pnpm --filter @gcg/web-configurator build

# 4. Deploy to fly.io
fly deploy
```

### Clean Build (Remove All Artifacts)

```bash
# Clean all packages
pnpm clean

# Or clean specific packages
pnpm --filter @gcg/hmi-ui clean
pnpm --filter @gcg/web-configurator clean
```

---

## üìù Package.json Scripts Reference

### HMI UI (`packages/hmi-ui/package.json`)

```json
{
  "build": "tsc && vite build", // ‚Üí dist/
  "deploy:web": "./scripts/deploy-to-web.sh", // ‚Üí garmin-bundle/
  "clean": "rm -rf dist node_modules/.vite"
}
```

### Web Configurator (`packages/web-configurator/package.json`)

```json
{
  "build": "node scripts/copy-hmi-assets.js && tsc && vite build",
  "prebuild": "node scripts/copy-hmi-assets.js", // Copies deployment-package/
  "clean": "rm -rf dist node_modules/.vite public/hmi-dist"
}
```

---

## üîç Verification

To verify build artifacts are being generated correctly:

```bash
# 1. Clean everything
pnpm clean

# 2. Build HMI UI
pnpm --filter @gcg/hmi-ui build
ls -lh packages/hmi-ui/dist/  # Should see build output

# 3. Deploy to bundle
pnpm --filter @gcg/hmi-ui deploy:web
ls -lh garmin-bundle/web/  # Should see deployed files

# 4. Build web configurator
pnpm --filter @gcg/web-configurator build
ls -lh packages/web-configurator/public/deployment-package/  # Should see package
ls -lh packages/web-configurator/dist/  # Should see web app build
```

---

## üí° Best Practices

1. **Never manually edit build artifacts** - They're auto-generated and will be overwritten
2. **Always run `pnpm clean` before troubleshooting** - Stale artifacts can cause confusion
3. **Don't commit build outputs** - They bloat the repository and cause merge conflicts
4. **Trust the build scripts** - The dependency chain is automated and tested
5. **Check `.gitignore`** - If you see build artifacts in git status, they should be ignored

---

## üêõ Troubleshooting

### "deployment-package not found"

```bash
# Run the copy script manually
node packages/web-configurator/scripts/copy-hmi-assets.js
```

### "HMI UI dist folder not found"

```bash
# Build HMI UI first
pnpm --filter @gcg/hmi-ui build
pnpm --filter @gcg/hmi-ui deploy:web
```

### "Stale build artifacts"

```bash
# Clean and rebuild
pnpm clean
pnpm build
```

### Build artifacts showing in `git status`

```bash
# Add to .gitignore and remove from git cache
echo "path/to/artifact/" >> .gitignore
git rm -r --cached path/to/artifact/
```

---

## üìä Artifact Size Reference

| Artifact                 | Typical Size | Cached in Git?         |
| ------------------------ | ------------ | ---------------------- |
| `hmi-ui/dist/`           | ~1.5MB       | ‚ùå No                  |
| `web-configurator/dist/` | ~800KB       | ‚ùå No                  |
| `deployment-package/`    | ~5.3MB       | ‚ùå No (as of cleanup)  |
| `garmin-bundle/`         | ~5MB         | ‚ùå No                  |
| `hmi-dist/` (legacy)     | ~1.2MB       | ‚ö†Ô∏è Yes (should remove) |

**Total build artifact size:** ~13MB (excluded from git)

---

## ‚úÖ Checklist

- [x] All `dist/` directories gitignored
- [x] `garmin-bundle/` gitignored
- [x] `deployment-package/` gitignored
- [ ] `hmi-dist/` should be gitignored (action needed)
- [x] Build scripts documented
- [x] Dependency chain explained
- [x] Clean scripts available

---

**Last updated:** October 12, 2025  
**Related docs:** `BLOAT_REMOVAL_CHECKLIST.md`, `BLOAT_ANALYSIS.md`
