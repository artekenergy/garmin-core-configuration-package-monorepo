# HMI UI Deployment Guide

**Last Updated**: October 3, 2025

This guide explains how to deploy the HMI UI to the Garmin display for testing.

---

## 📋 Prerequisites

1. **Built HMI UI**: The HMI UI package must be built
2. **Web Configurator**: A valid configuration exported from the configurator
3. **EmpirBus Tools**: Ability to create and upload `.ebp` files to the Garmin display

---

## 🚀 Deployment Process

### Step 1: Build and Deploy HMI UI

From the `packages/hmi-ui` directory:

```bash
pnpm deploy
```

This script will:

1. Build the production HMI UI (`pnpm build`)
2. Copy `dist/index.html` → `/web/index1.html`
3. Copy `dist/assets/` → `/web/hmi-assets/`
4. Copy `dist/schema.json` → `/web/schema.json`
5. Update asset paths in the HTML

**Output**:

```
✅ Deployment complete!

Files deployed to:
  - ../../web/index1.html
  - ../../web/hmi-assets/
  - ../../web/schema.json
```

---

### Step 2: Generate Configuration Schema

The `schema.json` file is generated by the web configurator's export function:

1. Open the web configurator at `http://localhost:3000`
2. Configure your system (Power, HVAC, Lighting, etc.)
3. Go to **Export** page
4. Click **"Download Configuration (config.zip)"**
5. Extract `schema.json` from the zip file
6. Copy `schema.json` to `/web/schema.json` (overwrites the test schema)

**Note**: The deployment script copies the test schema by default. For production, you need the configurator-generated schema.

---

### Step 3: Create EmpirBus Package (.ebp)

The EmpirBus package contains all the web assets that get deployed to the Garmin display.

**Using EmpirBus Tools** (manufacturer-specific process):

1. Package the `/web/` directory into an `.ebp` file
2. This includes:
   - `index1.html` (your new HMI UI)
   - `hmi-assets/` (JS/CSS bundles)
   - `schema.json` (your configuration)
   - All other web assets (icons, fonts, etc.)

**Output**: `configuration-name.ebp`

---

### Step 4: Upload to Garmin Display

**Via USB/Network** (device-specific):

1. Connect to the Garmin display
2. Upload the `.ebp` file using the EmpirBus upload tool
3. The display will install the package
4. Navigate to the HMI menu on the display
5. Your new UI should load from `index1.html`

---

## 🔍 Testing on Display

### What to Test:

1. **Schema Loading**:
   - UI should load without errors
   - Components should match your configuration

2. **Component Interactions**:
   - **Toggles**: Click to turn on/off (local state only until WebSocket connected)
   - **Buttons**: Press and hold, should show pressed state
   - **Indicators**: Should show current state (off/on/warning/error)

3. **WebSocket Connection** (once implemented in Step 6):
   - Components should send commands to EmpirBus
   - Physical outputs should respond to UI controls
   - UI should reflect actual hardware state

### Known Limitations (Current):

- ✅ UI renders components from schema
- ✅ Local component state (clicks work)
- ❌ **WebSocket not implemented yet** - No communication with EmpirBus controller
- ❌ Components use local state only
- ❌ No state synchronization with hardware

**Next Steps**: Implement Step 6 (WebSocket Adapter) to connect UI to EmpirBus.

---

## 📁 File Structure After Deployment

```
/web/
├── index1.html              ← Your HMI UI (replaces blank file)
├── hmi-assets/              ← Built JS/CSS assets
│   ├── index-[hash].js      ← Main application bundle
│   ├── vendor-[hash].js     ← Preact framework
│   ├── signals-[hash].js    ← Signals library
│   └── index-[hash].css     ← Compiled styles
├── schema.json              ← Generated from configurator
├── index.html               ← Original Garmin interface (untouched)
├── index2.html              ← Other displays (untouched)
└── [other original files]   ← Garmin web assets (untouched)
```

---

## 🛠️ Development Workflow

### Local Development:

```bash
cd packages/hmi-ui
pnpm dev
```

- Test at `http://localhost:3001`
- HMR for fast iteration
- Browser DevTools for debugging

### Deploy to Device:

```bash
cd packages/hmi-ui
pnpm deploy
# ... then create .ebp and upload
```

### Update Schema:

1. Make changes in web configurator
2. Export new `schema.json`
3. Copy to `/web/schema.json`
4. Re-deploy: `pnpm deploy`
5. Create new `.ebp` and upload

---

## 🐛 Troubleshooting

### Issue: UI doesn't load on display

**Check**:

- Is `index1.html` present in the `.ebp` package?
- Are all `hmi-assets/` files included?
- Is `schema.json` in the package root?

### Issue: Components not rendering

**Check**:

- Browser console for errors (if display has console access)
- Verify `schema.json` is valid (use configurator validation)
- Check asset paths in `index1.html` (should be `/hmi-assets/`)

### Issue: Blank screen

**Check**:

- ES2017 compatibility (no modern syntax should be in build)
- Check build output for errors: `pnpm build`
- Verify Vite config targets ES2017

### Issue: WebSocket not connecting

**Reminder**: WebSocket adapter not yet implemented (Step 6 pending)

---

## 📚 Related Documentation

- [HMI UI Implementation Plan](./HMI_UI_IMPLEMENTATION_PLAN.md)
- [System Architecture](./SYSTEM_ARCHITECTURE.md)
- [Web Configurator Export](./EXPORT_PAGE_COMPLETE.md)

---

## ✅ Quick Reference

**Deploy Command**:

```bash
cd packages/hmi-ui && pnpm deploy
```

**Build Only**:

```bash
cd packages/hmi-ui && pnpm build
```

**Dev Server**:

```bash
cd packages/hmi-ui && pnpm dev
```

**Output Locations**:

- Build output: `packages/hmi-ui/dist/`
- Deployed files: `/web/index1.html` and `/web/hmi-assets/`
